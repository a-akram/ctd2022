# HEADER
Bootstrap: docker
From: continuumio/miniconda3

# SECTIONS
%files
    README.md
    setup.py
    gpu_environment.yml

%post

    # *** Non-interactive Shell
    export DEBIAN_FRONTEND=noninteractive

    # *** Reconfigure Shell (or %post -c /bin/bash)
    dpkg-reconfigure dash

    # *** OS Upgrade & Install
    apt update && apt upgrade -y
    apt install -y git wget \
        build-essential \
        ca-certificates \
        libgl1-mesa-glx \
        libegl1-mesa \
        libxrandr2 \
        libxss1 \
        libxcursor1 \
        libxcomposite1 \
        libasound2 \
        libxi6 \
        libxtst6

    # Load Anaconda Environment Variables
    . /opt/conda/etc/profile.d/conda.sh

    # Update Conda
    conda update conda

    # *** Setting Up Envrionmnet
    conda env create -f gpu_environment.yml python=3.8
    conda activate exatrkx-gpu
    pip install -e .

    # *** Setup Conda Init ***
    profile="/etc/profile.d/conda.sh"
    cat <<EOF > ${profile}
    #!/bin/bash
    conda activate exatrkx-gpu
    EOF
    chmod a+x "${profile}"

    # *** Cleanup
    apt clean && \
    rm -rf /var/lib/apt/lists/*
    rm *.py *.yml *.md

%help

    To run this container with exatrkx-gpu conda environment, do:

    $ singularity exec mycontainer.sif bash -l -c "python main.py"
